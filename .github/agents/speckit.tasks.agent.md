```chatagent
---
description: 利用可能な設計成果物に基づいて、実行可能で依存関係順に並べられたtasks.mdをフィーチャー用に生成します。
handoffs: 
  - label: 整合性の分析
    agent: speckit.analyze
    prompt: プロジェクトの整合性分析を実行してください
    send: true
  - label: プロジェクトの実装
    agent: speckit.implement
    prompt: フェーズごとに実装を開始してください
    send: true
---

## ユーザー入力

```text
$ARGUMENTS
```

以下に進む前に、ユーザー入力を**必ず**考慮してください（空でない場合）。

## 概要

1. **セットアップ**: リポジトリルートから `.specify/scripts/bash/check-prerequisites.sh --json` を実行し、FEATURE_DIRとAVAILABLE_DOCSリストを解析します。すべてのパスは絶対パスでなければなりません。引数にシングルクォートが含まれる場合（例: "I'm Groot"）は、エスケープ構文を使用してください: 例 'I'\''m Groot'（または可能であればダブルクォート: "I'm Groot"）。

2. **設計ドキュメントの読み込み**: FEATURE_DIRから読み込み:
   - **必須**: plan.md（技術スタック、ライブラリ、構造）、spec.md（優先度付きユーザーストーリー）
   - **オプション**: data-model.md（エンティティ）、contracts/（APIエンドポイント）、research.md（決定事項）、quickstart.md（テストシナリオ）
   - 注意: すべてのプロジェクトにすべてのドキュメントがあるわけではありません。利用可能なものに基づいてタスクを生成してください。

3. **タスク生成ワークフローの実行**:
   - plan.mdを読み込み、技術スタック、ライブラリ、プロジェクト構造を抽出
   - spec.mdを読み込み、優先度付きユーザーストーリー（P1、P2、P3等）を抽出
   - data-model.mdが存在する場合: エンティティを抽出しユーザーストーリーにマッピング
   - contracts/が存在する場合: エンドポイントをユーザーストーリーにマッピング
   - research.mdが存在する場合: セットアップタスク用の決定事項を抽出
   - ユーザーストーリーごとに整理されたタスクを生成（以下のタスク生成ルール参照）
   - ユーザーストーリーの完了順序を示す依存関係グラフを生成
   - ユーザーストーリーごとの並列実行例を作成
   - タスクの完全性を検証（各ユーザーストーリーに必要なすべてのタスクがあり、独立してテスト可能）

4. **tasks.mdの生成**: `.specify/templates/tasks-template.md` を構造として使用し、以下を記入:
   - plan.mdからの正しいフィーチャー名
   - フェーズ1: セットアップタスク（プロジェクト初期化）
   - フェーズ2: 基盤タスク（すべてのユーザーストーリーのブロッキング前提条件）
   - フェーズ3以降: spec.mdの優先順位に従いユーザーストーリーごとに1フェーズ
   - 各フェーズに含める: ストーリーの目標、独立テスト基準、テスト（要求された場合）、実装タスク
   - 最終フェーズ: ポリッシュとクロスカッティング関心事
   - すべてのタスクは厳密なチェックリスト形式に従う（以下のタスク生成ルール参照）
   - 各タスクの明確なファイルパス
   - ストーリーの完了順序を示す依存関係セクション
   - ストーリーごとの並列実行例
   - 実装戦略セクション（MVP優先、インクリメンタルデリバリー）

5. **レポート**: 生成されたtasks.mdへのパスとサマリーを出力:
   - 合計タスク数
   - ユーザーストーリーごとのタスク数
   - 特定された並列実行の機会
   - 各ストーリーの独立テスト基準
   - 推奨MVPスコープ（通常はユーザーストーリー1のみ）
   - フォーマット検証: すべてのタスクがチェックリスト形式（チェックボックス、ID、ラベル、ファイルパス）に従っていることを確認

タスク生成のコンテキスト: $ARGUMENTS

tasks.mdはそのまま実行可能でなければなりません - 各タスクはLLMが追加のコンテキストなしで完了できるほど具体的である必要があります。

## タスク生成ルール

**重要**: タスクは独立した実装とテストを可能にするため、ユーザーストーリーごとに整理する**必要があります**。

**テストはオプション**: テストタスクはフィーチャー仕様で明示的に要求された場合、またはユーザーがTDDアプローチを要求した場合のみ生成します。

### チェックリスト形式（必須）

すべてのタスクは厳密に以下の形式に従う**必要があります**:

```text
- [ ] [TaskID] [P?] [Story?] ファイルパス付きの説明
```

**形式の構成要素**:

1. **チェックボックス**: 常に `- [ ]`（マークダウンチェックボックス）で開始
2. **タスクID**: 実行順の連番（T001、T002、T003...）
3. **[P] マーカー**: タスクが並列化可能な場合のみ含める（異なるファイル、未完了タスクへの依存なし）
4. **[Story] ラベル**: ユーザーストーリーフェーズのタスクにのみ必須
   - 形式: [US1]、[US2]、[US3]等（spec.mdのユーザーストーリーにマッピング）
   - セットアップフェーズ: ストーリーラベルなし
   - 基盤フェーズ: ストーリーラベルなし
   - ユーザーストーリーフェーズ: ストーリーラベル**必須**
   - ポリッシュフェーズ: ストーリーラベルなし
5. **説明**: 正確なファイルパス付きの明確なアクション

**例**:

- ✅ 正しい: `- [ ] T001 実装計画に従いプロジェクト構造を作成`
- ✅ 正しい: `- [ ] T005 [P] src/middleware/auth.pyに認証ミドルウェアを実装`
- ✅ 正しい: `- [ ] T012 [P] [US1] src/models/user.pyにUserモデルを作成`
- ✅ 正しい: `- [ ] T014 [US1] src/services/user_service.pyにUserServiceを実装`
- ❌ 間違い: `- [ ] Userモデルを作成`（IDとStorieラベルが不足）
- ❌ 間違い: `T001 [US1] モデルを作成`（チェックボックスが不足）
- ❌ 間違い: `- [ ] [US1] Userモデルを作成`（タスクIDが不足）
- ❌ 間違い: `- [ ] T001 [US1] モデルを作成`（ファイルパスが不足）

### タスクの整理

1. **ユーザーストーリーから（spec.md）** - 主要な整理軸:
   - 各ユーザーストーリー（P1、P2、P3...）が独自のフェーズを持つ
   - 関連するすべてのコンポーネントをストーリーにマッピング:
     - そのストーリーに必要なモデル
     - そのストーリーに必要なサービス
     - そのストーリーに必要なエンドポイント/UI
     - テストが要求された場合: そのストーリー固有のテスト
   - ストーリーの依存関係をマーク（ほとんどのストーリーは独立であるべき）

2. **コントラクトから**:
   - 各コントラクト/エンドポイント → それが提供するユーザーストーリーにマッピング
   - テストが要求された場合: 各コントラクト → そのストーリーのフェーズ内での実装前にコントラクトテストタスク [P]

3. **データモデルから**:
   - 各エンティティを必要とするユーザーストーリーにマッピング
   - エンティティが複数のストーリーに提供する場合: 最も早いストーリーまたはセットアップフェーズに配置
   - リレーションシップ → 適切なストーリーフェーズのサービスレイヤータスク

4. **セットアップ/インフラストラクチャから**:
   - 共有インフラストラクチャ → セットアップフェーズ（フェーズ1）
   - 基盤/ブロッキングタスク → 基盤フェーズ（フェーズ2）
   - ストーリー固有のセットアップ → そのストーリーのフェーズ内

### フェーズ構造

- **フェーズ1**: セットアップ（プロジェクト初期化）
- **フェーズ2**: 基盤（ブロッキング前提条件 - ユーザーストーリーの前に完了**必須**）
- **フェーズ3以降**: 優先順位順のユーザーストーリー（P1、P2、P3...）
  - 各ストーリー内: テスト（要求された場合）→ モデル → サービス → エンドポイント → 統合
  - 各フェーズは完全で独立してテスト可能なインクリメントであるべき
- **最終フェーズ**: ポリッシュとクロスカッティング関心事

```
