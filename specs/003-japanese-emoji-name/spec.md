# フィーチャー仕様: 日本語絵文字名対応（ひらがな・カタカナ・漢字）

**フィーチャーブランチ**: `003-japanese-emoji-name`
**作成日**: 2026-02-22
**ステータス**: ドラフト
**入力**: ユーザー説明: "絵文字名には日本語名ひらがな・カタカナ・漢字にも対応してほしい"
**前提**: `001-bulk-emoji-insert` + `002-ui-enhancement` の実装が完了済み

## 明確化事項

### セッション 2026-02-22

- Q: Slackは日本語絵文字名を受け付けるか？ → A: 公式ドキュメントではASCIIのみ。本改修では日本語文字をそのまま送信し、APIに判定を委ねる方針
- Q: 漢字のromaji変換は必要か？ → A: 不要。変換せずそのまま送信する
- Q: 内部 `/api/emoji.add` が日本語名を拒否した際に `error_bad_name_i18n` を返す可能性があるが、`error-messages.ts` に未登録のため対処するか？ → A: `error_bad_name_i18n` → `"絵文字名が無効です"` のマッピングを `error-messages.ts` に追加する（変更対象は `normalize.ts` + `error-messages.ts` の2ファイル）

## 目的（Why）

現在の正規化関数 `normalizeEmojiName()` は、ファイル名から英小文字・数字・ハイフン・アンダースコア以外の文字をすべて除去する。このため、日本語名のファイル（例: `笑顔.png`、`おはよう.png`、`ネコ.png`）をドロップすると絵文字名が空文字列になり、完全に無視される。

日本語ファイル名は日本のユーザーにとって自然な命名であり、ツールがこれを処理できないのは不便である。本改修で日本語文字（ひらがな・カタカナ・漢字）を正規化時に保持し、APIに送信可能にする。

## 用語

| 用語     | 定義                                                    |
| -------- | ------------------------------------------------------- |
| ひらがな | 日本語の音節文字（U+3040-U+309F）。例: あ、い、う       |
| カタカナ | 日本語の音節文字（U+30A0-U+30FF）。例: ア、イ、ウ       |
| 漢字     | 中国起源の表意文字（CJK統合漢字）。例: 笑、顔、猫       |
| 正規化   | ファイル名をSlack絵文字名として適切な形式に変換する処理 |

## ユーザーシナリオとテスト _（必須）_

### ユーザーストーリー1 — 日本語ファイル名の絵文字登録

ユーザーが日本語名のファイル（ひらがな・カタカナ・漢字を含む）をドロップした際、ファイル名の日本語部分が保持された状態でAPIに送信される。SlackがAPIで受け入れた場合は登録成功、拒否した場合はエラーメッセージが表示される。

**独立テスト**: 日本語名のファイルをドロップし、絵文字名に日本語文字が含まれた状態でリストに表示されることを確認する。

**受け入れシナリオ**:

1. **前提** 正常なセッション、**操作** `笑顔.png` をドロップする、**期待** リスト行に `:笑顔:` と表示され、APIに `笑顔` として送信される
2. **前提** 正常なセッション、**操作** `おはよう.png` をドロップする、**期待** リスト行に `:おはよう:` と表示される
3. **前提** 正常なセッション、**操作** `ネコ.png` をドロップする、**期待** リスト行に `:ネコ:` と表示される
4. **前提** 正常なセッション、**操作** `Hello_世界.png` をドロップする、**期待** リスト行に `:hello_世界:` と表示される（ASCII部分は小文字化、日本語部分は保持）
5. **前提** Slackが日本語名を拒否する、**操作** `笑顔.png` をドロップして登録処理が行われる、**期待** ❌ の横に「絵文字名が無効です」と表示される

---

### エッジケース / 失敗時の挙動

- **全角英数字**: `ＨＥＬＬＯ.png` → 全角英数字は既存の正規化ではサニタイズ対象。本改修のスコープ外（全角→半角変換は将来の改善として別途検討）
- **混合ファイル名**: `happy_笑顔_test.png` → `happy_笑顔_test`（ASCII小文字化 + 日本語保持）
- **日本語のみで構成されたファイル名**: `笑顔.png` → `笑顔`（空文字にならない）
- **絵文字や記号**: `😀.png` → 絵文字Unicodeは対象範囲外のため除去 → 空文字 → スキップ
- **長音符・句読点**: `ラーメン.png` →「ー」はカタカナ範囲（U+30FC）に含まれるため保持 → `ラーメン`

## 要件 _（必須）_

### 機能要件

#### Must（必須）

- **FR-301**: `normalizeEmojiName()` は、ひらがな（U+3040-U+309F）をサニタイズ時に除去してはならない（MUST NOT）
- **FR-302**: `normalizeEmojiName()` は、カタカナ（U+30A0-U+30FF）をサニタイズ時に除去してはならない（MUST NOT）
- **FR-303**: `normalizeEmojiName()` は、CJK統合漢字（U+4E00-U+9FFF）をサニタイズ時に除去してはならない（MUST NOT）
- **FR-304**: `normalizeEmojiName()` は、CJK統合漢字拡張A（U+3400-U+4DBF）をサニタイズ時に除去してはならない（MUST NOT）
- **FR-305**: `normalizeEmojiName()` は、CJK互換漢字（U+F900-U+FAFF）をサニタイズ時に除去してはならない（MUST NOT）
- **FR-306**: 既存のASCII正規化ルール（小文字化、空白→`_`、英小文字・数字・ハイフン・アンダースコアの保持）は維持しなければならない（MUST）
- **FR-307**: `src/ui/error-messages.ts` に `error_bad_name_i18n` → `"絵文字名が無効です"` のマッピングを追加しなければならない（MUST）

### キーエンティティ

- **変更対象**: `normalizeEmojiName()` 関数（`src/utils/normalize.ts`）の sanitize regex + `src/ui/error-messages.ts` の `ERROR_MESSAGES` マッピング

## 仮定

- 002-ui-enhancement の実装がすべて完了し、ビルド可能な状態である
- Slack APIが日本語絵文字名を拒否した場合、既存のエラーメッセージ表示機構（`invalid_name` → 「絵文字名が無効です」）で対処する
- 全角英数字→半角英数字の変換は本改修のスコープ外とする

## 成功基準 _（必須）_

### 測定可能な成果

- **SC-301**: ひらがなファイル名（例: `おはよう.png`）でドロップ時に絵文字名が `:おはよう:` として表示される
- **SC-302**: カタカナファイル名（例: `ネコ.png`）でドロップ時に絵文字名が `:ネコ:` として表示される
- **SC-303**: 漢字ファイル名（例: `笑顔.png`）でドロップ時に絵文字名が `:笑顔:` として表示される
- **SC-304**: 既存のASCIIファイル名の動作に変更がないこと
- **SC-305**: 既存のコンスティテューション（50行制限・早期リターン・単一責任・any禁止）をすべて遵守する
