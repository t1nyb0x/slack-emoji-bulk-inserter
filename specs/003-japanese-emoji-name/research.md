# 調査: 日本語絵文字名対応（ひらがな・カタカナ・漢字）

**フィーチャーブランチ**: `003-japanese-emoji-name`
**作成日**: 2026-02-22

---

## 調査1: Slack emoji.add API は日本語文字を受け付けるか？

### 決定事項

Slack API は絵文字名に **ASCII小文字・数字・ハイフン・アンダースコアのみ** を受け付ける。日本語文字（ひらがな・カタカナ・漢字）は公式にはサポートされていない。

### 根拠

- 公式ドキュメント（`admin.emoji.add`）は `name` パラメータについて "The name of the emoji to be added (using lower-case letters only)" と記載
- 先行ツール（neutral-face-emoji-tools, slack-emojinator, emojipacks）のいずれも、非ASCII絵文字名のサポート事例なし
- `error_bad_name_i18n` の `_i18n` はエラーメッセージの国際化版であり、Unicode名サポートを意味しない

### 検討した代替案

- **APIの非公式動作に期待**: 公式ドキュメントと矛盾するため不採用
- **将来のAPI更新を期待**: 本改修では「そのまま送信してAPIに判定を委ねる」アプローチで将来対応を自然にカバー

---

## 調査2: 日本語ファイル名の変換アプローチ

### 決定事項

**日本語文字をそのまま保持してAPIに送信し、判定をSlackに委ねる** アプローチを採用する。

### 根拠

- ユーザーの選択に基づく
- 最もシンプルな実装（正規化関数のregex修正のみ）
- 外部ライブラリ不要でバンドルサイズ増加なし
- Slackが将来的に日本語名を受け入れた場合、コード変更なしで自動対応
- 拒否された場合は既存のエラーメッセージ表示機構（002-ui-enhancement）で日本語エラーが表示される

### 検討した代替案

| アプローチ | 評価 | 不採用理由 |
|-----------|------|-----------|
| wanakana でひらがな・カタカナのみromaji変換 | △ | 漢字未対応、ライブラリ追加（~15KB）が必要 |
| kuroshiro で漢字含む全変換 | × | 辞書ファイル数MBでChrome拡張には重すぎる |
| 現状維持（日本語除去）| × | ユーザー要件を満たさない |

---

## 調査3: 正規化関数で保持すべきUnicode範囲

### 決定事項

以下のUnicode範囲を `normalizeEmojiName()` の sanitize regex で許可する。

| 文字種 | Unicode範囲 | 例 |
|--------|------------|-----|
| ひらがな | U+3040-U+309F | あ-ん |
| カタカナ | U+30A0-U+30FF | ア-ン |
| CJK統合漢字 | U+4E00-U+9FFF | 一-龥 |
| CJK統合漢字拡張A | U+3400-U+4DBF | 㐀-䶵 |
| CJK互換漢字 | U+F900-U+FAFF | 豈-頻 |

### 根拠

- ひらがな・カタカナは日本語の基本文字セット
- CJK統合漢字（基本 + 拡張A）で常用漢字・人名漢字を含む大半の日本語漢字をカバー
- CJK互換漢字は異体字を含むため追加
- 拡張B以降（U+20000-）はサロゲートペアが必要だが、絵文字名に使用される可能性は極めて低いため対象外

### 検討した代替案

- **Unicode Property Escapes (`\p{Script=Hiragana}` 等)**: ES2018以降でサポート。Chrome拡張のターゲット（chrome120）で利用可能。ただし `/[^...]/gu` フラグが必要になり、既存の正規化フローとの整合性を考慮して範囲指定を採用
- **`\p{Unified_Ideograph}`**: Unicode Property Escape の一種。シンプルだが範囲をコントロールしにくい

---

## 調査4: `toLowerCase()` と日本語文字の互換性

### 決定事項

JavaScript の `String.prototype.toLowerCase()` は日本語文字（ひらがな・カタカナ・漢字）に影響しない。現行のステップ2はそのまま維持する。

### 根拠

- ひらがな・カタカナには大文字/小文字の概念がない
- 漢字にも大文字/小文字の概念がない
- `"こんにちは".toLowerCase()` → `"こんにちは"` （変化なし）

### 検討した代替案

- **カタカナ→ひらがな変換**: Slackが仮名を区別するかどうか不明のため、変換しない方が安全
