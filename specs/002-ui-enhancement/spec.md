# フィーチャー仕様: UI改修 — エラーメッセージ・サムネイル・重複検知

**フィーチャーブランチ**: `002-ui-enhancement`
**作成日**: 2026-02-22
**ステータス**: ドラフト
**入力**: ユーザー説明: "UI改修: エラーメッセージ表示・サムネイルプレビュー・重複検知"
**前提**: `001-bulk-emoji-insert` の実装が完了済み

## 目的（Why）

001-bulk-emoji-insert で一括登録機能のMVPは完成しているが、以下3点のUX上の不足がある。

1. **エラーメッセージが見えない**: 登録失敗時に ❌ アイコンだけ表示され、原因が分からない
2. **どの画像か判別できない**: 絵文字名（テキスト）だけのリストでは、どの画像がどの行かを直感的に把握できない
3. **重複ファイル名の検知がない**: 同じファイル名を2回ドロップすると二重登録を試みてしまい、不要なAPIコールが発生する

本改修でこれら3点を解消し、ユーザーの操作体験を向上させる。

## 用語

| 用語 | 定義 |
| --- | --- |
| エラーメッセージ | 登録失敗時にリスト行に表示される、失敗原因の日本語テキスト |
| サムネイル | リスト行に表示される画像のプレビュー（24×24px） |
| 重複検知 | キュー内の既存アイテムと同じ絵文字名が検出された場合にスキップする機能 |
| Skippedステータス | 重複検知によりAPI呼び出しをスキップされた状態を示す新しいステータス |

## ユーザーシナリオとテスト _（必須）_

### ユーザーストーリー1 — 登録失敗時のエラーメッセージ表示（優先度: P1）

ユーザーが複数の絵文字をドロップして登録を実行した際、一部の絵文字が登録に失敗した場合、❌ アイコンの横に失敗原因を日本語テキストで表示する。これにより、ユーザーは「同名の絵文字が既に存在する」「セッションが切れている」等の原因を即座に理解し、対処できる。

**この優先度の理由**: エラー原因が不明のまま放置されるとユーザーの不信感につながる。最も基本的なUX改善。

**独立テスト**: 既に存在する絵文字名で画像をドロップし、リスト行に日本語のエラーメッセージが表示されることを確認する。

**受け入れシナリオ**:

1. **前提** Slackに `:test:` 絵文字が既に存在する、**操作** `test.png` をドロップする、**期待** ❌ の横に「同名の絵文字が既に登録されています」と表示される
2. **前提** セッショントークンが有効、**操作** 不正な名前のファイルをドロップし正規化後に空になる、**期待** 正規化で空になったアイテムはリストに追加されない（既存仕様どおり）
3. **前提** ネットワーク障害が発生している、**操作** 画像をドロップし登録処理が行われる、**期待** ❌ の横に「ネットワークエラーが発生しました」と表示される

---

### ユーザーストーリー2 — サムネイルプレビュー表示（優先度: P2）

ユーザーが画像ファイルをドロップした後、各絵文字のリスト行にサムネイル画像（24×24px）が表示される。これにより、テキスト（絵文字名）だけでなく視覚的にも「どの画像をどの名前で登録しようとしているか」を確認できる。

**この優先度の理由**: 大量の画像をドロップした場合に個々の内容を目視確認することが重要。ただし無くても機能には支障がない。

**独立テスト**: 複数の画像をドロップし、各行に画像のサムネイルが表示されることを確認する。

**受け入れシナリオ**:

1. **前提** カスタマイズページが開いている、**操作** 3枚のPNG画像をドロップする、**期待** 各リスト行に [ステータスアイコン] [サムネイル画像] [:絵文字名:] が表示される
2. **前提** カスタマイズページが開いている、**操作** GIF画像をドロップする、**期待** アニメーションGIFのサムネイルが表示される

---

### ユーザーストーリー3 — ドロップ時の重複絵文字名検知（優先度: P2）

ユーザーが同じファイル名の画像を2回ドロップした場合、2回目のアイテムは自動的にスキップされ、⚠️ アイコンと「同じ名前の絵文字がキュー内に存在します」というメッセージが表示される。APIへの不要なリクエストを防ぐ。

**この優先度の理由**: 不要なAPI呼び出しを減らしレートリミットリスクを低減する。誤操作も自然に防げる。

**独立テスト**: 同じファイル名の画像を2回ドロップし、2回目のアイテムが ⚠️ 付きでスキップされることを確認する。

**受け入れシナリオ**:

1. **前提** `smile.png` が既にキューにある、**操作** もう一度 `smile.png` をドロップする、**期待** 2回目の `:smile:` は ⚠️ アイコンと「同じ名前の絵文字がキュー内に存在します」と表示され、API呼び出しは行われない
2. **前提** `smile.png` がキューに無い、**操作** `smile.png` をドロップする、**期待** 通常どおり ⏳ で登録キューに追加される
3. **前提** 処理完了後、**操作** サマリーを表示する、**期待** 「スキップ: N件」がサマリーに表示される

---

### エッジケース / 失敗時の挙動

- **未知のエラーコードがAPIから返された場合**: 「登録に失敗しました（エラーコード: xxx）」と表示する
- **大量のファイルドロップ時のサムネイル生成**: `URL.createObjectURL` は軽量のため性能問題はない。画像ロード後に `revokeObjectURL` でメモリを解放する
- **リスト行のレイアウト崩れ**: サムネイルは固定サイズ（24×24px）で `object-fit: contain` を使用し、アスペクト比を維持する
- **スキップされたアイテムの処理順序**: `processItem` でステータスが `Skipped` のアイテムはスキップする

## 要件 _（必須）_

### 機能要件

#### Must（必須）

- **FR-101**: 登録失敗時に、リスト行の ❌ アイコンの横にエラー原因を日本語テキストで表示しなければならない（MUST）
- **FR-102**: 主要なSlack APIエラーコード（`error_name_taken`、`error_name_taken_i18n`、`too_many_emoji`、`not_authed`、`invalid_auth`、`ratelimited`、`network_error`）に対して、対応する日本語メッセージを返す関数を用意しなければならない（MUST）
- **FR-103**: 各リスト行にドロップされた画像のサムネイル（24×24px）を表示しなければならない（MUST）
- **FR-104**: 同じ絵文字名がキュー内に既に存在する場合、重複アイテムをAPIに送信せずスキップしなければならない（MUST）
- **FR-105**: スキップされたアイテムは ⚠️ アイコンとスキップ理由を表示しなければならない（MUST）
- **FR-106**: 処理完了サマリーにスキップ件数を含めなければならない（MUST）

#### Should（推奨）

- **FR-107**: サムネイル画像はロード完了後に `URL.revokeObjectURL` でメモリを解放すべきである（SHOULD）

### キーエンティティ

- **EmojiStatus**: 既存の4ステータス（Pending, Uploading, Success, Failed）に `Skipped` を追加
- **EmojiRegistrationItem**: 既存の型をそのまま使用（`errorCode` フィールドでメッセージを導出）

## 仮定

- 001-bulk-emoji-insert の実装がすべて完了し、ビルド可能な状態である
- 既存のファイル構造・命名規則・コーディング規約を維持する
- 新規ファイルの追加は最小限とし、既存モジュールの拡張を優先する

## 成功基準 _（必須）_

### 測定可能な成果

- **SC-101**: 登録失敗時に必ず日本語テキストでエラー原因が表示される（エラーメッセージなしの ❌ 行が0件）
- **SC-102**: すべてのリスト行にサムネイル画像が表示され、画像内容を目視確認できる
- **SC-103**: 同じファイル名を2回ドロップした場合、2回目のアイテムがスキップされ、APIリクエストが発行されない
- **SC-104**: 既存のコンスティテューション（50行制限・早期リターン・単一責任・any禁止）をすべて遵守する
