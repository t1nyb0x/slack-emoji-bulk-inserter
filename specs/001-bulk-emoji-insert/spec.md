# フィーチャー仕様: Slack絵文字一括登録

**フィーチャーブランチ**: `001-bulk-emoji-insert`
**作成日**: 2026-02-22
**ステータス**: ドラフト
**入力**: ユーザー説明: "Slackのカスタマイズページでの絵文字追加を一括で行うChrome拡張機能。画像をドラッグ＆ドロップすることで絵文字をすべて追加する。"

## 明確化事項

### セッション 2026-02-22

- Q: 絵文字の登録手段は何を使用するか？ → A: Slack内部API（`/api/emoji.add`）をページのセッション情報で呼び出す
- Q: ドロップゾーンの表示位置はどこか？ → A: ページ上部に独立した固定パネルとして挿入する
- Q: API呼び出しのレートリミット対策はどうするか？ → A: 各リクエスト間に固定ディレイ（500ms〜1秒）を挟む
- Q: 絵文字名の正規化ルールは？ → A: 大文字→小文字変換、空白・ドット→`_`置換、英小文字・数字・`-`・`_`以外は除去
- Q: 処理中に追加ドロップされた場合の挙動は？ → A: 既存の登録キューの末尾に追加し、順次処理を継続する

## 目的（Why）

Slackワークスペースにカスタム絵文字を登録する際、現状では1つずつ手動で追加する必要があり、大量の絵文字を登録する場合に多大な時間と手間がかかる。本拡張機能は、Slackのカスタマイズページ（`{workspace}.slack.com/customize/emoji`）上で複数の画像ファイルをドラッグ＆ドロップするだけで一括登録を実現し、絵文字登録作業を大幅に簡略化する。

## 用語

| 用語               | 定義                                                                                                 |
| ------------------ | ---------------------------------------------------------------------------------------------------- |
| カスタマイズページ | Slackの絵文字管理ページ（`https://{workspace}.slack.com/customize/emoji`）                           |
| 絵文字名           | Slackで `:emoji_name:` として使用される識別子。画像ファイル名（拡張子除去）から自動生成される        |
| ドロップゾーン     | カスタマイズページ上部に固定パネルとして挿入される、画像ファイルをドラッグ＆ドロップで受け付ける領域 |
| ステータスアイコン | 各絵文字の登録状態（待機中・処理中・成功・失敗）を視覚的に示すアイコン                               |
| バルク登録         | 複数の絵文字を一括で連続的にSlackへ登録する処理                                                      |

## ユーザーシナリオとテスト _（必須）_

### ユーザーストーリー1 - 絵文字の一括ドラッグ＆ドロップ登録（優先度: P1）

ユーザーはSlackのカスタマイズページを開いた状態で、拡張機能がページ上部に挿入した固定パネル（ドロップゾーン）に複数の画像ファイルをドラッグ＆ドロップする。拡張機能はドロップされた画像ファイルのファイル名（拡張子を除いた部分）を絵文字名として使用し、Slack内部API（`/api/emoji.add`）を呼び出して各絵文字を順次登録する。各リクエスト間には固定ディレイ（500ms〜1秒）を挟み、レートリミットを回避する。

**この優先度の理由**: 絵文字の一括登録が本拡張機能の核心的な価値であり、この機能なしにはプロダクトとして成立しない。

**独立テスト**: カスタマイズページでドロップゾーンに画像をドロップし、絵文字が実際にSlackに登録されることを確認することで完全にテスト可能であり、「手作業の繰り返しからの解放」という価値を提供する。

**受け入れシナリオ**:

1. **前提** ユーザーがSlackカスタマイズページを開いている、**操作** 複数の画像ファイル（例: PNG 3枚）をドロップゾーンにドラッグ＆ドロップする、**期待** 各画像のファイル名が絵文字名として表示され、すべての絵文字が順次Slackに登録される
2. **前提** ユーザーがSlackカスタマイズページを開いている、**操作** 1枚の画像ファイルをドロップゾーンにドラッグ＆ドロップする、**期待** その画像が絵文字名とともに表示され、Slackに登録される
3. **前提** ユーザーがSlackカスタマイズページ以外のページを開いている、**操作** ページを表示する、**期待** ドロップゾーンは表示されない（拡張機能はカスタマイズページでのみ動作する）

---

### ユーザーストーリー2 - 登録状況のリアルタイム表示（優先度: P2）

ユーザーは絵文字をドロップした後、各絵文字の登録状態をステータスアイコンと絵文字名で確認できる。待機中・処理中・成功・失敗の状態がリアルタイムに更新され、登録の進捗を一目で把握できる。

**この優先度の理由**: 一括登録の処理には時間がかかるため、ユーザーが現在の状態を把握できるフィードバックは不可欠。ただし、登録機能自体が先に動作することが前提。

**独立テスト**: 複数の画像をドロップし、各絵文字の横にステータスアイコンが表示され、登録の進行に伴いアイコンが変化することを目視確認することでテスト可能。

**受け入れシナリオ**:

1. **前提** 複数の画像がドロップされている、**操作** 登録処理が進行する、**期待** 各絵文字のステータスアイコンが「待機中→処理中→成功」の順に変化する
2. **前提** 複数の画像がドロップされている、**操作** 一部の絵文字の登録が失敗する（例: 同名の絵文字が既に存在）、**期待** 失敗した絵文字のステータスアイコンが「失敗」に変化し、他の絵文字の登録は継続される
3. **前提** 複数の画像がドロップされている、**操作** 各絵文字のリスト項目を確認する、**期待** 各項目にステータスアイコンと絵文字名が表示されている

---

### エッジケース / 失敗時の挙動

- **同名の絵文字が既に存在する場合**: 該当の絵文字はスキップされ、ステータスアイコンが「失敗」に変化する。他の絵文字の登録は継続される
- **画像以外のファイルがドロップされた場合**: 非対応ファイルは無視され、登録リストに追加されない
- **ネットワークエラーが発生した場合**: 通信に失敗した絵文字のステータスアイコンが「失敗」に変化する。他の絵文字の登録は継続される
- **Slackのセッションが切れている場合**: 登録に失敗し、ステータスアイコンが「失敗」に変化する
- **ファイル名に使用不可文字が含まれる場合**: 大文字→小文字変換、空白・ドット→`_`置換を行い、英小文字・数字・`-`・`_`以外の文字は除去して絵文字名を生成する
- **0件のファイルがドロップされた場合**: 何も起こらない（エラーは表示しない）
- **非常に大量のファイル（100枚以上）がドロップされた場合**: すべてキューに追加し、順次処理する。リストが長くなってもスクロールで確認可能
- **処理中に追加の画像がドロップされた場合**: 新しい画像を既存の登録キューの末尾に追加し、順次処理を継続する

## 要件 _（必須）_

### 機能要件

#### Must（必須）

- **FR-001**: 拡張機能はSlackのカスタマイズページ（`{workspace}.slack.com/customize/emoji`）でのみ動作しなければならない（MUST）
- **FR-002**: ユーザーは画像ファイルをドラッグ＆ドロップでドロップゾーンに追加できなければならない（MUST）
- **FR-003**: ドロップされた画像ファイルのファイル名（拡張子除去）を絵文字名として使用しなければならない（MUST）
- **FR-004**: ドロップされた複数の絵文字をSlack内部API（`/api/emoji.add`）を使用して順次登録しなければならない（MUST）
- **FR-005**: 各絵文字の登録状態をステータスアイコン（待機中・処理中・成功・失敗）で表示しなければならない（MUST）
- **FR-006**: 各絵文字の絵文字名をリスト上に表示しなければならない（MUST）
- **FR-007**: 1つの絵文字の登録が失敗しても、残りの絵文字の登録を継続しなければならない（MUST）
- **FR-008**: 不要な情報（ユーザーデータ、閲覧履歴等）を収集してはならない（MUST NOT）

- **FR-012**: 各絵文字登録リクエスト間に固定ディレイ（500ms〜1秒）を挟まなければならない（MUST）
- **FR-013**: 処理中に追加の画像がドロップされた場合、既存の登録キューの末尾に追加して処理を継続しなければならない（MUST）

#### Should（推奨）

- **FR-009**: Slackの絵文字名規則に適合しないファイル名は自動的に正規化すべきである（大文字→小文字、空白・ドット→`_`、それ以外の不正文字は除去）（SHOULD）
- **FR-010**: 画像以外のファイルがドロップされた場合は無視すべきである（SHOULD）

#### Could（あれば望ましい）

- **FR-011**: 登録完了後に成功件数・失敗件数のサマリーを表示できると望ましい（COULD）

### キーエンティティ

- **絵文字登録アイテム**: ドロップされた1つの画像ファイルに対応する。画像データ、絵文字名（ファイル名から導出）、登録ステータス（待機中・処理中・成功・失敗）を持つ
- **ドロップゾーン**: カスタマイズページ上に表示される、画像ファイルの受付領域。ドラッグ中のハイライト表示状態を持つ

## 仮定

- ユーザーはSlackワークスペースに管理者またはカスタム絵文字追加権限を持つメンバーとしてログイン済みである
- Slackのカスタマイズページの構造（DOM・API）は予告なく変更される可能性がある
- 絵文字の登録はページに埋め込まれたセッション情報（`api_token`）を利用してSlack内部API（`/api/emoji.add`）を呼び出す
- 対応画像形式はSlackが受け付ける形式（PNG、JPEG、GIF）に準拠する

## 成功基準 _（必須）_

### 測定可能な成果

- **SC-001**: ユーザーは10個の絵文字を手動登録の場合と比較して80%以上短い時間で登録を完了できる
- **SC-002**: ドロップされたすべての有効な画像ファイルが漏れなくSlackに登録される（成功率100%、Slack側エラーを除く）
- **SC-003**: 各絵文字の登録状態がリアルタイムにステータスアイコンとして反映され、処理中に最新の状態が常に確認できる
- **SC-004**: 拡張機能はスコープ外の情報（閲覧履歴、個人データ等）を一切収集しない
